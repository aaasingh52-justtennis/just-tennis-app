<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Just Tennis Season 4 - Ladder</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            padding-top: 70px;
            color: #333;
            background-color: #f5f7fa;
        }
        h1 {
            color: #2c5282;
            border-bottom: 3px solid #2c5282;
            padding-bottom: 10px;
            margin-bottom: 5px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 20px;
        }
        /* Sticky Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background-color: #f5f7fa;
            padding: 15px 20px;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .nav-tab {
            padding: 10px 20px;
            background-color: #e2e8f0;
            color: #4a5568;
            text-decoration: none;
            border-radius: 8px 8px 0 0;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        .nav-tab:hover {
            background-color: #cbd5e0;
        }
        .nav-tab.active {
            background-color: #2c5282;
            color: white;
        }
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #666;
        }
        .error {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #c53030;
            background-color: #fff5f5;
            border-radius: 8px;
        }
        .info-box {
            background-color: #ebf8ff;
            border-left: 4px solid #4299e1;
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }
        .table-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        th {
            background-color: #2c5282;
            color: white;
            padding: 12px 10px;
            text-align: left;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
        }
        td {
            border-bottom: 1px solid #e2e8f0;
            padding: 10px;
        }
        tr:hover {
            background-color: #f7fafc;
        }
        .rank-cell {
            font-weight: bold;
            font-size: 16px;
        }
        /* Playoff cutoff line - red border after rank 16 */
        tr.playoff-cutoff td {
            border-bottom: 3px solid #c53030;
        }
        .playoff-indicator {
            background-color: #fff5f5;
            border-left: 4px solid #c53030;
            padding: 10px 15px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
            font-size: 14px;
            color: #c53030;
        }
        .stat-highlight {
            font-weight: bold;
            color: #2c5282;
        }
        .win-pct {
            color: #276749;
        }
        .zero-matches {
            color: #a0aec0;
            font-style: italic;
        }
        @media (max-width: 768px) {
            .nav-tabs {
                padding: 10px 15px;
            }
            .nav-tab {
                padding: 8px 12px;
                font-size: 14px;
            }
            td, th {
                padding: 8px 6px;
                font-size: 13px;
            }
        }
    </style>
</head>
<body>

<nav class="nav-tabs">
    <a href="index.html" class="nav-tab">Contact List</a>
    <a href="ladder.html" class="nav-tab active">Ladder</a>
    <a href="matches.html" class="nav-tab">Matches</a>
    <a href="rules.html" class="nav-tab">Rules</a>
</nav>

<h1>üèÜ Just Tennis Season 4 - Ladder</h1>
<p class="subtitle">Live standings updated automatically after each match</p>

<div class="info-box">
    <strong>Ranking System:</strong> Players earn up to 5 points per match (1 participation + 2 win bonus + 1 per set won, capped at 5). 
    Ties broken by: Match Win % ‚Üí Set Win % ‚Üí Earlier registration.
</div>

<div class="playoff-indicator">
    <strong>üéØ Playoff Cutoff:</strong> Top 16 players qualify for playoffs. Red line indicates the cutoff.
</div>

<div class="table-container">
    <div id="loadingMessage" class="loading">Loading standings...</div>
    <div id="errorMessage" class="error" style="display: none;"></div>
    <table id="ladderTable" style="display: none;">
        <thead>
            <tr>
                <th>Rank</th>
                <th>ID</th>
                <th>Name</th>
                <th>Points</th>
                <th>Played</th>
                <th>Won</th>
                <th>Lost</th>
                <th>Win %</th>
                <th>Sets W</th>
                <th>Sets L</th>
            </tr>
        </thead>
        <tbody id="ladderTableBody">
        </tbody>
    </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="config.js"></script>
<script>
    const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // Calculate standings from matches
    async function loadStandings() {
        try {
            // Load all players
            const { data: players, error: playersError } = await db
                .from('players')
                .select('id, name')
                .eq('is_active', true);
            
            if (playersError) throw playersError;
            
            // Load all matches
            const { data: matches, error: matchesError } = await db
                .from('matches')
                .select('*');
            
            if (matchesError) throw matchesError;
            
            // Calculate stats for each player
            const standings = players.map(player => {
                const playerMatches = matches.filter(m => 
                    m.player_a_id === player.id || m.player_b_id === player.id
                );
                
                let totalPoints = 0;
                let matchesWon = 0;
                let setsWon = 0;
                let setsLost = 0;
                
                playerMatches.forEach(match => {
                    const isPlayerA = match.player_a_id === player.id;
                    const playerSets = isPlayerA ? match.player_a_sets : match.player_b_sets;
                    const opponentSets = isPlayerA ? match.player_b_sets : match.player_a_sets;
                    const isWinner = match.winner_id === player.id;
                    
                    // Points: 1 (participation) + 2 (if winner) + sets won, capped at 5
                    const matchPoints = Math.min(1 + (isWinner ? 2 : 0) + playerSets, 5);
                    totalPoints += matchPoints;
                    
                    if (isWinner) matchesWon++;
                    setsWon += playerSets;
                    setsLost += opponentSets;
                });
                
                const matchesPlayed = playerMatches.length;
                const matchesLost = matchesPlayed - matchesWon;
                const winPct = matchesPlayed > 0 ? (matchesWon / matchesPlayed * 100) : 0;
                const setPct = (setsWon + setsLost) > 0 ? (setsWon / (setsWon + setsLost) * 100) : 0;
                
                return {
                    id: player.id,
                    name: player.name,
                    points: totalPoints,
                    matchesPlayed,
                    matchesWon,
                    matchesLost,
                    winPct,
                    setsWon,
                    setsLost,
                    setPct
                };
            });
            
            // Sort by: points DESC, winPct DESC, setPct DESC, id ASC
            standings.sort((a, b) => {
                if (b.points !== a.points) return b.points - a.points;
                if (b.winPct !== a.winPct) return b.winPct - a.winPct;
                if (b.setPct !== a.setPct) return b.setPct - a.setPct;
                return a.id - b.id; // Earlier registration wins ties
            });
            
            renderStandings(standings);
            
        } catch (error) {
            console.error('Error loading standings:', error);
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('errorMessage').textContent = 
                'Error loading standings. Please refresh the page or try again later.';
        }
    }
    
    function renderStandings(standings) {
        const tbody = document.getElementById('ladderTableBody');
        
        tbody.innerHTML = standings.map((player, index) => {
            const rank = index + 1;
            const isPlayoffCutoff = rank === 16;
            const zeroMatches = player.matchesPlayed === 0;
            
            return `
                <tr class="${isPlayoffCutoff ? 'playoff-cutoff' : ''}">
                    <td class="rank-cell">${rank}</td>
                    <td>${player.id}</td>
                    <td>${player.name}</td>
                    <td class="stat-highlight">${player.points}</td>
                    <td class="${zeroMatches ? 'zero-matches' : ''}">${player.matchesPlayed}</td>
                    <td>${player.matchesWon}</td>
                    <td>${player.matchesLost}</td>
                    <td class="win-pct">${player.winPct.toFixed(1)}%</td>
                    <td>${player.setsWon}</td>
                    <td>${player.setsLost}</td>
                </tr>
            `;
        }).join('');
        
        document.getElementById('loadingMessage').style.display = 'none';
        document.getElementById('ladderTable').style.display = 'table';
    }
    
    // Load standings on page load
    loadStandings();
</script>

</body>
</html>
