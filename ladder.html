<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Just Tennis Season 4 - Ladder</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif; margin: 0; padding: 20px; padding-top: 70px;
            color: #333; background-color: #f5f7fa;
        }
        h1 { color: #2c5282; border-bottom: 3px solid #2c5282; padding-bottom: 10px; }
        
        .nav-tabs {
            display: flex; gap: 5px; margin-bottom: 20px; flex-wrap: wrap;
            position: fixed; top: 0; left: 0; right: 0;
            background-color: #f5f7fa; padding: 15px 20px; z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .nav-tab {
            padding: 10px 20px; background-color: #e2e8f0; color: #4a5568;
            text-decoration: none; border-radius: 8px 8px 0 0; font-weight: bold;
        }
        .nav-tab:hover { background-color: #cbd5e0; }
        .nav-tab.active { background-color: #2c5282; color: white; }
        
        .table-container { background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { background-color: #2c5282; color: white; padding: 12px 10px; text-align: left; white-space: nowrap; }
        td { border-bottom: 1px solid #e2e8f0; padding: 10px; }
        tr:hover { background-color: #f7fafc; }
        
        .playoff-cutoff td { border-bottom: 3px solid #c53030; }
        .stat-highlight { font-weight: bold; color: #2c5282; }
    </style>
</head>
<body>

<nav class="nav-tabs">
    <a href="index.html" class="nav-tab">Contact List</a>
    <a href="ladder.html" class="nav-tab active">Ladder</a>
    <a href="matches.html" class="nav-tab">Matches</a>
    <a href="report-match.html" class="nav-tab">Report Score</a>
    <a href="rules.html" class="nav-tab">Rules</a>
</nav>

<h1>üèÜ Ladder Standings</h1>

<div class="table-container">
    <div id="loadingMessage" style="padding:40px; text-align:center;">Calculating standings...</div>
    <table id="ladderTable" style="display: none;">
        <thead>
            <tr>
                <th>Rank</th>
                <th>Name</th>
                <th>Points</th>
                <th>Played</th>
                <th>Won</th>
                <th>Lost</th>
                <th>Win %</th>
                <th>Sets W</th>
                <th>Sets L</th>
            </tr>
        </thead>
        <tbody id="ladderTableBody"></tbody>
    </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    const SUPABASE_URL = 'https://bykttkozszstkkxtdeza.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ5a3R0a296c3pzdGtreHRkZXphIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzYyNjg4MTIsImV4cCI6MjA1MTg0NDgxMn0.8WpvP2QGpJVcaL_fKABjMtDRbnKL2-j4KwRsYyGi6XQ';
    const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    async function initLadder() {
        try {
            // 1. Fetch Players and Matches
            const [playersRes, matchesRes] = await Promise.all([
                db.from('players').select('id, name').eq('is_active', true).order('id'), // Ordered by ID (Join Date)
                db.from('matches').select('*').order('date', { ascending: false })
            ]);

            if (playersRes.error) throw playersRes.error;
            if (matchesRes.error) throw matchesRes.error;

            const players = playersRes.data;
            const matches = matchesRes.data;

            // 2. Filter Matches (Max 3 per pair)
            const pairMatches = {};
            const validMatches = [];

            // Sort matches newest first (already done by DB, but safe to ensure)
            matches.sort((a, b) => new Date(b.date) - new Date(a.date));

            matches.forEach(m => {
                // Create unique key for pair: "minID-maxID"
                const id1 = Math.min(m.player_a_id, m.player_b_id);
                const id2 = Math.max(m.player_a_id, m.player_b_id);
                const pairKey = `${id1}-${id2}`;

                if (!pairMatches[pairKey]) pairMatches[pairKey] = 0;
                
                if (pairMatches[pairKey] < 3) {
                    pairMatches[pairKey]++;
                    validMatches.push(m); // Keep this match
                }
            });

            // 3. Calculate Stats
            const stats = {};
            players.forEach(p => {
                stats[p.id] = {
                    id: p.id,
                    name: p.name,
                    points: 0,
                    played: 0,
                    wins: 0,
                    losses: 0,
                    setsWon: 0,
                    setsLost: 0
                };
            });

            validMatches.forEach(m => {
                // Calculate points for this specific match
                // Logic: 1 (play) + 1 per set + 2 (win) -> min(5)
                const winnerBonus = 2;
                const participation = 1;
                
                // Determine A and B points
                const ptsA = Math.min(5, participation + (m.winner_id === m.player_a_id ? winnerBonus : 0) + m.player_a_sets);
                const ptsB = Math.min(5, participation + (m.winner_id === m.player_b_id ? winnerBonus : 0) + m.player_b_sets);

                // Update Player A
                if (stats[m.player_a_id]) {
                    const s = stats[m.player_a_id];
                    s.played++;
                    s.points += ptsA;
                    s.setsWon += m.player_a_sets;
                    s.setsLost += m.player_b_sets;
                    if (m.winner_id === m.player_a_id) s.wins++; else s.losses++;
                }

                // Update Player B
                if (stats[m.player_b_id]) {
                    const s = stats[m.player_b_id];
                    s.played++;
                    s.points += ptsB;
                    s.setsWon += m.player_b_sets;
                    s.setsLost += m.player_a_sets;
                    if (m.winner_id === m.player_b_id) s.wins++; else s.losses++;
                }
            });

            // 4. Sort / Rank
            // Rule: 1. Points, 2. Win %, 3. Set Win %, 4. ID (Join Order)
            const ladder = Object.values(stats).sort((a, b) => {
                if (b.points !== a.points) return b.points - a.points;
                
                const winPctA = a.played ? a.wins / a.played : 0;
                const winPctB = b.played ? b.wins / b.played : 0;
                if (winPctB !== winPctA) return winPctB - winPctA;

                const setPctA = (a.setsWon + a.setsLost) ? a.setsWon / (a.setsWon + a.setsLost) : 0;
                const setPctB = (b.setsWon + b.setsLost) ? b.setsWon / (b.setsWon + b.setsLost) : 0;
                if (setPctB !== setPctA) return setPctB - setPctA;

                return a.id - b.id; // Lower ID (earlier join) wins
            });

            renderLadder(ladder);

        } catch (err) {
            console.error(err);
            document.getElementById('loadingMessage').textContent = "Error loading ladder.";
        }
    }

    function renderLadder(ladder) {
        const tbody = document.getElementById('ladderTableBody');
        tbody.innerHTML = ladder.map((p, index) => {
            const winPct = p.played ? Math.round((p.wins / p.played) * 100) : 0;
            return `
            <tr class="${index === 15 ? 'playoff-cutoff' : ''}">
                <td style="font-weight:bold">${index + 1}</td>
                <td>${p.name}</td>
                <td class="stat-highlight">${p.points}</td>
                <td>${p.played}</td>
                <td>${p.wins}</td>
                <td>${p.losses}</td>
                <td>${winPct}%</td>
                <td>${p.setsWon}</td>
                <td>${p.setsLost}</td>
            </tr>
            `;
        }).join('');

        document.getElementById('loadingMessage').style.display = 'none';
        document.getElementById('ladderTable').style.display = 'table';
    }

    initLadder();
</script>
</body>
</html>