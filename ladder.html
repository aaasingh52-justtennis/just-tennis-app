<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Just Tennis Season 4 - Ladder</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            color: #333;
            background-color: #f5f7fa;
        }
        h1 {
            color: #2c5282;
            border-bottom: 3px solid #2c5282;
            padding-bottom: 10px;
            margin-bottom: 5px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 20px;
        }
        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .nav-tab {
            padding: 10px 20px;
            background-color: #e2e8f0;
            color: #4a5568;
            text-decoration: none;
            border-radius: 8px 8px 0 0;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        .nav-tab:hover {
            background-color: #cbd5e0;
        }
        .nav-tab.active {
            background-color: #2c5282;
            color: white;
        }
        .info-box {
            background-color: #ebf8ff;
            border-left: 4px solid #4299e1;
            padding: 20px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }
        .table-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        th {
            background-color: #2c5282;
            color: white;
            padding: 12px 10px;
            text-align: left;
        }
        td {
            border-bottom: 1px solid #e2e8f0;
            padding: 10px;
        }
        tr:hover {
            background-color: #f7fafc;
        }
        .rank-1 { background-color: #ffd700; }
        .rank-2 { background-color: #e8e8e8; }
        .rank-3 { background-color: #cd7f32; color: white; }
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #666;
        }
    </style>
</head>
<body>

<h1>ðŸŽ¾ Just Tennis Season 4 - Ladder</h1>
<p class="subtitle">January 1 - April 1, 2026 | Rankings updated after each match</p>

<nav class="nav-tabs">
    <a href="index.html" class="nav-tab">Contact List</a>
    <a href="ladder.html" class="nav-tab active">Ladder</a>
    <a href="matches.html" class="nav-tab">Matches</a>
    <a href="rules.html" class="nav-tab">Rules</a>
</nav>

<div class="info-box">
    <strong>Points System:</strong> MIN(1 + 2Ã—win + sets_won, 5) per match<br>
    <strong>Tiebreakers:</strong> Match Win % â†’ Set Win % â†’ Order of Joining
</div>

<div class="table-container">
    <div id="loadingMessage" class="loading">Loading standings...</div>
    <table id="ladderTable" style="display: none;">
        <thead>
            <tr>
                <th>Rank</th>
                <th>Name</th>
                <th>Points</th>
                <th>Played</th>
                <th>Won</th>
                <th>Lost</th>
                <th>Win %</th>
                <th>Sets +/-</th>
            </tr>
        </thead>
        <tbody id="ladderTableBody">
        </tbody>
    </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    const SUPABASE_URL = 'https://bykttkozszstkkxtdeza.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ5a3R0a296c3pzdGtreHRkZXphIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2OTc0ODgsImV4cCI6MjA4MzI3MzQ4OH0.-PTH-tQTmhg53QBzbaYeYaj__3JXpITrCxJR3AGXY3c';
    
    const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    async function loadLadder() {
        try {
            // Get all players
            const { data: players, error: playersError } = await db
                .from('players')
                .select('id, name')
                .eq('is_active', true);
            
            if (playersError) throw playersError;
            
            // Get all matches
            const { data: matches, error: matchesError } = await db
                .from('matches')
                .select('*');
            
            if (matchesError) throw matchesError;
            
            // Calculate standings
            const standings = players.map(player => {
                const playerMatches = matches.filter(m => 
                    m.player_a_id === player.id || m.player_b_id === player.id
                );
                
                let points = 0;
                let wins = 0;
                let setsWon = 0;
                let setsLost = 0;
                
                playerMatches.forEach(match => {
                    const isPlayerA = match.player_a_id === player.id;
                    const mySets = isPlayerA ? match.player_a_sets : match.player_b_sets;
                    const oppSets = isPlayerA ? match.player_b_sets : match.player_a_sets;
                    const didWin = match.winner_id === player.id;
                    
                    setsWon += mySets;
                    setsLost += oppSets;
                    
                    if (didWin) wins++;
                    
                    // Points: MIN(1 + 2*win + sets_won, 5)
                    const matchPoints = Math.min(1 + (didWin ? 2 : 0) + mySets, 5);
                    points += matchPoints;
                });
                
                const played = playerMatches.length;
                const winPct = played > 0 ? (wins / played * 100).toFixed(1) : '0.0';
                
                return {
                    id: player.id,
                    name: player.name,
                    points,
                    played,
                    wins,
                    losses: played - wins,
                    winPct: parseFloat(winPct),
                    setsWon,
                    setsLost,
                    setDiff: setsWon - setsLost
                };
            });
            
            // Sort by points, then win%, then set%, then ID
            standings.sort((a, b) => {
                if (b.points !== a.points) return b.points - a.points;
                if (b.winPct !== a.winPct) return b.winPct - a.winPct;
                const aSetPct = a.setsWon + a.setsLost > 0 ? a.setsWon / (a.setsWon + a.setsLost) : 0;
                const bSetPct = b.setsWon + b.setsLost > 0 ? b.setsWon / (b.setsWon + b.setsLost) : 0;
                if (bSetPct !== aSetPct) return bSetPct - aSetPct;
                return a.id - b.id; // Lower ID wins tie
            });
            
            // Render table
            const tbody = document.getElementById('ladderTableBody');
            tbody.innerHTML = standings.map((player, index) => {
                const rank = index + 1;
                let rankClass = '';
                if (rank === 1) rankClass = 'rank-1';
                else if (rank === 2) rankClass = 'rank-2';
                else if (rank === 3) rankClass = 'rank-3';
                
                return `
                    <tr>
                        <td class="${rankClass}">${rank}</td>
                        <td>${player.name}</td>
                        <td><strong>${player.points}</strong></td>
                        <td>${player.played}</td>
                        <td>${player.wins}</td>
                        <td>${player.losses}</td>
                        <td>${player.winPct}%</td>
                        <td>${player.setsWon}-${player.setsLost} (${player.setDiff >= 0 ? '+' : ''}${player.setDiff})</td>
                    </tr>
                `;
            }).join('');
            
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('ladderTable').style.display = 'table';
            
        } catch (error) {
            console.error('Error loading ladder:', error);
            document.getElementById('loadingMessage').textContent = 
                'Error loading ladder. Please refresh the page.';
        }
    }
    
    loadLadder();
</script>

</body>
</html>
