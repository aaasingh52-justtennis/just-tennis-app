<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Just Tennis Season 4 - Matches</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            padding-top: 70px;
            color: #333;
            background-color: #f5f7fa;
        }
        h1 {
            color: #2c5282;
            border-bottom: 3px solid #2c5282;
            padding-bottom: 10px;
            margin-bottom: 5px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 20px;
        }
        /* Sticky Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background-color: #f5f7fa;
            padding: 15px 20px;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .nav-tab {
            padding: 10px 20px;
            background-color: #e2e8f0;
            color: #4a5568;
            text-decoration: none;
            border-radius: 8px 8px 0 0;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        .nav-tab:hover {
            background-color: #cbd5e0;
        }
        .nav-tab.active {
            background-color: #2c5282;
            color: white;
        }
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #666;
        }
        .error {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #c53030;
            background-color: #fff5f5;
            border-radius: 8px;
        }
        .controls {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .controls-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 180px;
        }
        .filter-group label {
            font-size: 12px;
            font-weight: bold;
            color: #4a5568;
            margin-bottom: 4px;
        }
        .filter-group select,
        .filter-group input {
            padding: 8px 10px;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            font-size: 14px;
        }
        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.2);
        }
        .vs-text {
            font-weight: bold;
            color: #4a5568;
            padding: 8px 0;
            font-size: 14px;
        }
        .reset-btn {
            padding: 8px 16px;
            background-color: #fc8181;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        .reset-btn:hover {
            background-color: #f56565;
        }
        .results-count {
            padding: 8px 16px;
            background-color: #ebf8ff;
            border-radius: 4px;
            font-size: 14px;
            color: #2c5282;
            font-weight: bold;
        }
        .head-to-head-info {
            background-color: #f0fff4;
            border-left: 4px solid #48bb78;
            padding: 10px 15px;
            margin-top: 15px;
            border-radius: 0 8px 8px 0;
            font-size: 14px;
            display: none;
        }
        .head-to-head-info.show {
            display: block;
        }
        .h2h-stats {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 8px;
        }
        .h2h-stat {
            font-weight: bold;
        }
        .h2h-player1 {
            color: #2c5282;
        }
        .h2h-player2 {
            color: #805ad5;
        }
        .table-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        th {
            background-color: #2c5282;
            color: white;
            padding: 12px 10px;
            text-align: left;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
        }
        td {
            border-bottom: 1px solid #e2e8f0;
            padding: 10px;
        }
        tr:hover {
            background-color: #f7fafc;
        }
        tr.hidden {
            display: none;
        }
        .winner-name {
            color: #276749;
            font-weight: bold;
        }
        .loser-name {
            color: #c53030;
        }
        .score-display {
            font-family: monospace;
            font-size: 14px;
            background-color: #edf2f7;
            padding: 2px 8px;
            border-radius: 4px;
        }
        .no-matches {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }
        @media (max-width: 768px) {
            .filter-group {
                min-width: 100%;
            }
            .nav-tabs {
                padding: 10px 15px;
            }
            .nav-tab {
                padding: 8px 12px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>

<nav class="nav-tabs">
    <a href="index.html" class="nav-tab">Contact List</a>
    <a href="ladder.html" class="nav-tab">Ladder</a>
    <a href="matches.html" class="nav-tab active">Matches</a>
    <a href="rules.html" class="nav-tab">Rules</a>
</nav>

<h1>ðŸ“Š Just Tennis Season 4 - Matches</h1>
<p class="subtitle">Match history and head-to-head records</p>

<div class="controls">
    <div class="controls-row">
        <div class="filter-group">
            <label>Player 1 (type to search)</label>
            <input type="text" id="filterPlayer1" list="playerList1" placeholder="Select or type name...">
            <datalist id="playerList1"></datalist>
        </div>
        <span class="vs-text">vs</span>
        <div class="filter-group">
            <label>Player 2 (for head-to-head)</label>
            <input type="text" id="filterPlayer2" list="playerList2" placeholder="Select or type name...">
            <datalist id="playerList2"></datalist>
        </div>
        <div class="filter-group">
            <label>Result (for Player 1)</label>
            <select id="filterResult">
                <option value="">All Results</option>
                <option value="won">Won</option>
                <option value="lost">Lost</option>
            </select>
        </div>
        <button class="reset-btn" onclick="resetFilters()">Reset Filters</button>
        <div class="results-count"><span id="resultCount">0</span> matches shown</div>
    </div>
    <div id="headToHeadInfo" class="head-to-head-info">
        <strong>Head-to-Head Record:</strong>
        <div class="h2h-stats">
            <span class="h2h-stat h2h-player1"><span id="h2hPlayer1Name">-</span>: <span id="h2hPlayer1Wins">0</span> wins</span>
            <span class="h2h-stat h2h-player2"><span id="h2hPlayer2Name">-</span>: <span id="h2hPlayer2Wins">0</span> wins</span>
        </div>
    </div>
</div>

<div class="table-container">
    <div id="loadingMessage" class="loading">Loading matches...</div>
    <div id="errorMessage" class="error" style="display: none;"></div>
    <div id="noMatchesMessage" class="no-matches" style="display: none;">No matches found for the selected filters.</div>
    <table id="matchesTable" style="display: none;">
        <thead>
            <tr>
                <th>Date</th>
                <th>Winner</th>
                <th>Score</th>
                <th>Loser</th>
            </tr>
        </thead>
        <tbody id="matchesTableBody">
        </tbody>
    </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="config.js"></script>
<script>
    const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    let allMatches = [];
    let allPlayers = {};
    let playersList = []; // Array for easier lookup
    
    // Load data
    async function loadData() {
        try {
            // Load players first
            const { data: players, error: playersError } = await db
                .from('players')
                .select('id, name')
                .eq('is_active', true)
                .order('name');
            
            if (playersError) throw playersError;
            
            // Create player lookup and populate datalists
            const datalist1 = document.getElementById('playerList1');
            const datalist2 = document.getElementById('playerList2');
            
            players.forEach(player => {
                allPlayers[player.id] = player.name;
                playersList.push({ id: player.id, name: player.name });
                
                const option1 = document.createElement('option');
                option1.value = `${player.name} (#${player.id})`;
                option1.dataset.playerId = player.id;
                datalist1.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = `${player.name} (#${player.id})`;
                option2.dataset.playerId = player.id;
                datalist2.appendChild(option2);
            });
            
            // Load matches for current season
            const { data: matches, error: matchesError } = await db
                .from('matches')
                .select('*')
                .eq('season_id', 1)  // Season 4 = season_id 1
                .order('date', { ascending: false });
            
            if (matchesError) throw matchesError;
            
            allMatches = matches;
            renderMatches(allMatches);
            
        } catch (error) {
            console.error('Error loading data:', error);
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('errorMessage').textContent = 
                'Error loading matches. Please refresh the page or try again later.';
        }
    }
    
    // Extract player ID from input value (handles both "Name (#ID)" format and partial matches)
    function getPlayerIdFromInput(inputValue) {
        if (!inputValue) return null;
        
        // Try to extract ID from "Name (#ID)" format
        const match = inputValue.match(/#(\d+)\)?$/);
        if (match) {
            return parseInt(match[1]);
        }
        
        // Try to find player by name (case-insensitive partial match)
        const searchTerm = inputValue.toLowerCase().trim();
        const foundPlayer = playersList.find(p => 
            p.name.toLowerCase() === searchTerm ||
            p.name.toLowerCase().startsWith(searchTerm)
        );
        
        return foundPlayer ? foundPlayer.id : null;
    }
    
    function renderMatches(matches) {
        const tbody = document.getElementById('matchesTableBody');
        const noMatchesMsg = document.getElementById('noMatchesMessage');
        const table = document.getElementById('matchesTable');
        
        document.getElementById('loadingMessage').style.display = 'none';
        
        if (matches.length === 0) {
            table.style.display = 'none';
            noMatchesMsg.style.display = 'block';
            document.getElementById('resultCount').textContent = '0';
            return;
        }
        
        noMatchesMsg.style.display = 'none';
        table.style.display = 'table';
        
        tbody.innerHTML = matches.map(match => {
            const winnerName = allPlayers[match.winner_id] || 'Unknown';
            const loserId = match.player_a_id === match.winner_id ? match.player_b_id : match.player_a_id;
            const loserName = allPlayers[loserId] || 'Unknown';
            
            const winnerSets = match.player_a_id === match.winner_id ? match.player_a_sets : match.player_b_sets;
            const loserSets = match.player_a_id === match.winner_id ? match.player_b_sets : match.player_a_sets;
            
            const dateFormatted = new Date(match.date).toLocaleDateString('en-GB', {
                day: 'numeric',
                month: 'short',
                year: 'numeric'
            });
            
            return `
                <tr data-player-a="${match.player_a_id}" 
                    data-player-b="${match.player_b_id}" 
                    data-winner="${match.winner_id}">
                    <td>${dateFormatted}</td>
                    <td class="winner-name">${winnerName}</td>
                    <td><span class="score-display">${winnerSets} - ${loserSets}</span></td>
                    <td class="loser-name">${loserName}</td>
                </tr>
            `;
        }).join('');
        
        document.getElementById('resultCount').textContent = matches.length;
    }
    
    function applyFilters() {
        const player1Input = document.getElementById('filterPlayer1').value;
        const player2Input = document.getElementById('filterPlayer2').value;
        const resultFilter = document.getElementById('filterResult').value;
        const h2hInfo = document.getElementById('headToHeadInfo');
        
        const player1Id = getPlayerIdFromInput(player1Input);
        const player2Id = getPlayerIdFromInput(player2Input);
        
        let filteredMatches = allMatches;
        
        // Head-to-head mode: both players selected
        if (player1Id && player2Id) {
            filteredMatches = allMatches.filter(match => {
                const players = [match.player_a_id, match.player_b_id];
                return players.includes(player1Id) && players.includes(player2Id);
            });
            
            // Calculate head-to-head stats
            let player1Wins = 0;
            let player2Wins = 0;
            
            filteredMatches.forEach(match => {
                if (match.winner_id === player1Id) {
                    player1Wins++;
                } else if (match.winner_id === player2Id) {
                    player2Wins++;
                }
            });
            
            // Show H2H info
            document.getElementById('h2hPlayer1Name').textContent = allPlayers[player1Id];
            document.getElementById('h2hPlayer2Name').textContent = allPlayers[player2Id];
            document.getElementById('h2hPlayer1Wins').textContent = player1Wins;
            document.getElementById('h2hPlayer2Wins').textContent = player2Wins;
            h2hInfo.classList.add('show');
            
        } else if (player1Id) {
            // Single player filter
            filteredMatches = allMatches.filter(match => 
                match.player_a_id === player1Id || 
                match.player_b_id === player1Id
            );
            h2hInfo.classList.remove('show');
            
            // Apply result filter if set
            if (resultFilter === 'won') {
                filteredMatches = filteredMatches.filter(match => 
                    match.winner_id === player1Id
                );
            } else if (resultFilter === 'lost') {
                filteredMatches = filteredMatches.filter(match => 
                    match.winner_id !== player1Id
                );
            }
        } else {
            h2hInfo.classList.remove('show');
        }
        
        renderMatches(filteredMatches);
    }
    
    function resetFilters() {
        document.getElementById('filterPlayer1').value = '';
        document.getElementById('filterPlayer2').value = '';
        document.getElementById('filterResult').value = '';
        document.getElementById('headToHeadInfo').classList.remove('show');
        renderMatches(allMatches);
    }
    
    // Event listeners - use 'input' for datalist to catch both typing and selection
    document.getElementById('filterPlayer1').addEventListener('input', applyFilters);
    document.getElementById('filterPlayer2').addEventListener('input', applyFilters);
    document.getElementById('filterResult').addEventListener('change', applyFilters);
    
    // Load data on page load
    loadData();
</script>

</body>
</html>
