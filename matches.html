<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Just Tennis Season 4 - Match Results</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            color: #333;
            background-color: #f5f7fa;
        }
        h1 {
            color: #2c5282;
            border-bottom: 3px solid #2c5282;
            padding-bottom: 10px;
            margin-bottom: 5px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 20px;
        }
        
        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .nav-tab {
            padding: 10px 20px;
            background-color: #e2e8f0;
            color: #4a5568;
            text-decoration: none;
            border-radius: 8px 8px 0 0;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        .nav-tab:hover {
            background-color: #cbd5e0;
        }
        .nav-tab.active {
            background-color: #2c5282;
            color: white;
        }
        
        /* Filter Controls */
        .controls {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .controls-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 200px;
            position: relative;
        }
        .filter-group label {
            font-size: 12px;
            font-weight: bold;
            color: #4a5568;
            margin-bottom: 4px;
        }
        
        /* Searchable Dropdown */
        .search-dropdown {
            position: relative;
        }
        .search-input {
            width: 100%;
            padding: 10px 35px 10px 12px;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            font-size: 14px;
        }
        .search-input:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.2);
        }
        .search-input::placeholder {
            color: #a0aec0;
        }
        .dropdown-arrow {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: #718096;
            font-size: 10px;
        }
        .dropdown-list {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 100;
            max-height: 300px;
            overflow-y: auto;
        }
        .dropdown-list.show {
            display: block;
        }
        .dropdown-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }
        .dropdown-item:hover {
            background-color: #ebf8ff;
        }
        .dropdown-item.selected {
            background-color: #bee3f8;
            font-weight: bold;
        }
        .dropdown-item:last-child {
            border-bottom: none;
        }
        .dropdown-item .player-id {
            color: #718096;
            font-size: 12px;
            margin-left: 8px;
        }
        .no-results {
            padding: 10px 12px;
            color: #718096;
            font-style: italic;
        }
        
        /* Toggle Buttons */
        .toggle-group {
            display: flex;
            gap: 0;
        }
        .toggle-btn {
            padding: 10px 16px;
            border: 1px solid #cbd5e0;
            background: white;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .toggle-btn:first-child {
            border-radius: 4px 0 0 4px;
        }
        .toggle-btn:last-child {
            border-radius: 0 4px 4px 0;
        }
        .toggle-btn:not(:first-child) {
            border-left: none;
        }
        .toggle-btn:hover {
            background-color: #f7fafc;
        }
        .toggle-btn.active {
            background-color: #2c5282;
            color: white;
            border-color: #2c5282;
        }
        .toggle-btn.active + .toggle-btn {
            border-left-color: #2c5282;
        }
        
        /* Clear Button */
        .clear-btn {
            padding: 10px 16px;
            background-color: #fc8181;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        .clear-btn:hover {
            background-color: #f56565;
        }
        
        /* Match Count */
        .match-count {
            padding: 10px 15px;
            background-color: #ebf8ff;
            border-radius: 4px;
            font-size: 14px;
            color: #2c5282;
            font-weight: bold;
            display: inline-block;
        }
        
        .table-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        th {
            background-color: #2c5282;
            color: white;
            padding: 12px 10px;
            text-align: left;
            position: sticky;
            top: 0;
            cursor: pointer;
            white-space: nowrap;
        }
        th:hover {
            background-color: #2a4365;
        }
        th .sort-icon {
            margin-left: 5px;
            opacity: 0.5;
        }
        th.sorted .sort-icon {
            opacity: 1;
        }
        td {
            border-bottom: 1px solid #e2e8f0;
            padding: 10px;
        }
        tr:hover {
            background-color: #f7fafc;
        }
        .winner {
            font-weight: bold;
            color: #276749;
        }
        .loser {
            color: #718096;
        }
        .score {
            font-weight: bold;
            font-size: 16px;
            text-align: center;
        }
        .date-cell {
            white-space: nowrap;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }
        .error {
            text-align: center;
            padding: 40px;
            color: #c53030;
            display: none;
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #718096;
        }
        
        @media (max-width: 768px) {
            .filter-group {
                min-width: 100%;
            }
            .controls-row {
                flex-direction: column;
                align-items: stretch;
            }
            .toggle-group {
                width: 100%;
            }
            .toggle-btn {
                flex: 1;
            }
        }
    </style>
</head>
<body>

<h1>ðŸŽ¾ Just Tennis Season 4 - Match Results</h1>
<p class="subtitle">January 1 - April 1, 2026</p>

<nav class="nav-tabs">
    <a href="index.html" class="nav-tab">Contact List</a>
    <a href="ladder.html" class="nav-tab">Ladder</a>
    <a href="matches.html" class="nav-tab active">Matches</a>
    <a href="rules.html" class="nav-tab">Rules</a>
</nav>

<div class="controls">
    <div class="controls-row">
        <div class="filter-group">
            <label>Filter by Player</label>
            <div class="search-dropdown">
                <input type="text" 
                       id="playerSearch" 
                       class="search-input" 
                       placeholder="ðŸ” Search player..."
                       autocomplete="off">
                <span class="dropdown-arrow">â–¼</span>
                <div class="dropdown-list" id="playerDropdown">
                    <div class="loading">Loading players...</div>
                </div>
            </div>
        </div>
        
        <div class="filter-group">
            <label>Match Result</label>
            <div class="toggle-group">
                <button class="toggle-btn active" data-filter="all">All</button>
                <button class="toggle-btn" data-filter="wins">Wins</button>
                <button class="toggle-btn" data-filter="losses">Losses</button>
            </div>
        </div>
        
        <button class="clear-btn" onclick="clearFilters()">Clear Filters</button>
        <div class="match-count"><span id="matchCount">0</span> matches shown</div>
    </div>
</div>

<div id="loadingMessage" class="loading">Loading match results...</div>
<div id="errorMessage" class="error">Error loading matches.</div>

<div class="table-container">
    <table id="matchesTable" style="display: none;">
        <thead>
            <tr>
                <th onclick="sortTable(0)">Date <span class="sort-icon">â†•</span></th>
                <th onclick="sortTable(1)">Winner <span class="sort-icon">â†•</span></th>
                <th>Score</th>
                <th onclick="sortTable(3)">Loser <span class="sort-icon">â†•</span></th>
            </tr>
        </thead>
        <tbody id="matchesTableBody">
        </tbody>
    </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    const SUPABASE_URL = 'https://bykttkozszstkkxtdeza.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ5a3R0a296c3pzdGtreHRkZXphIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2OTc0ODgsImV4cCI6MjA4MzI3MzQ4OH0.-PTH-tQTmhg53QBzbaYeYaj__3JXpITrCxJR3AGXY3c';
    
    const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // State
    let allPlayers = [];
    let allMatches = [];
    let playerMap = {};
    let selectedPlayerId = null;
    let resultFilter = 'all';
    
    // Load matches from Supabase
    async function loadMatches() {
        try {
            // Get all players for dropdown and name lookup
            const { data: players, error: playerError } = await db
                .from('players')
                .select('id, name')
                .eq('is_active', true)
                .order('name', { ascending: true });
            
            if (playerError) throw playerError;
            
            allPlayers = players;
            players.forEach(p => playerMap[p.id] = p.name);
            
            // Get all matches
            const { data: matches, error: matchError } = await db
                .from('matches')
                .select('*')
                .order('date', { ascending: false });
            
            if (matchError) throw matchError;
            
            allMatches = matches;
            
            // Populate player dropdown
            populatePlayerDropdown();
            
            // Render matches
            renderMatches();
            
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('matchesTable').style.display = 'table';
            
        } catch (error) {
            console.error('Error loading matches:', error);
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'block';
        }
    }
    
    // Populate player dropdown
    function populatePlayerDropdown() {
        renderDropdownItems(allPlayers);
    }
    
    function renderDropdownItems(players) {
        const dropdown = document.getElementById('playerDropdown');
        
        if (players.length === 0) {
            dropdown.innerHTML = '<div class="no-results">No matching players</div>';
            return;
        }
        
        dropdown.innerHTML = players.map(player => `
            <div class="dropdown-item ${selectedPlayerId === player.id ? 'selected' : ''}" 
                 data-id="${player.id}" 
                 onclick="selectPlayer(${player.id}, '${player.name.replace(/'/g, "\\'")}')">
                ${player.name}<span class="player-id">#${player.id}</span>
            </div>
        `).join('');
    }
    
    // Player search and dropdown handlers
    const searchInput = document.getElementById('playerSearch');
    const dropdown = document.getElementById('playerDropdown');
    
    searchInput.addEventListener('focus', () => {
        dropdown.classList.add('show');
        if (searchInput.value === '' || searchInput.value === searchInput.dataset.selectedName) {
            renderDropdownItems(allPlayers);
        }
    });
    
    searchInput.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const filtered = allPlayers.filter(p => 
            p.name.toLowerCase().includes(searchTerm) || 
            p.id.toString().includes(searchTerm)
        );
        renderDropdownItems(filtered);
        dropdown.classList.add('show');
        
        // Clear selection if user is typing something different
        if (searchInput.dataset.selectedName && 
            searchInput.value.toLowerCase() !== searchInput.dataset.selectedName.toLowerCase()) {
            selectedPlayerId = null;
            searchInput.dataset.selectedName = '';
            renderMatches();
        }
    });
    
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.search-dropdown')) {
            dropdown.classList.remove('show');
            // Restore selected player name if cleared during search
            if (selectedPlayerId && searchInput.dataset.selectedName) {
                searchInput.value = searchInput.dataset.selectedName;
            }
        }
    });
    
    function selectPlayer(id, name) {
        selectedPlayerId = id;
        searchInput.value = name;
        searchInput.dataset.selectedName = name;
        dropdown.classList.remove('show');
        renderDropdownItems(allPlayers);
        renderMatches();
    }
    
    // Toggle buttons
    document.querySelectorAll('.toggle-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            resultFilter = btn.dataset.filter;
            renderMatches();
        });
    });
    
    // Clear filters
    function clearFilters() {
        selectedPlayerId = null;
        resultFilter = 'all';
        searchInput.value = '';
        searchInput.dataset.selectedName = '';
        document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
        document.querySelector('.toggle-btn[data-filter="all"]').classList.add('active');
        renderDropdownItems(allPlayers);
        renderMatches();
    }
    
    // Render matches table
    function renderMatches() {
        const tbody = document.getElementById('matchesTableBody');
        
        let filteredMatches = allMatches;
        
        // Filter by selected player
        if (selectedPlayerId) {
            filteredMatches = filteredMatches.filter(m => 
                m.player_a_id === selectedPlayerId || m.player_b_id === selectedPlayerId
            );
            
            // Then filter by win/loss
            if (resultFilter === 'wins') {
                filteredMatches = filteredMatches.filter(m => m.winner_id === selectedPlayerId);
            } else if (resultFilter === 'losses') {
                filteredMatches = filteredMatches.filter(m => m.winner_id !== selectedPlayerId);
            }
        }
        
        // Update count
        document.getElementById('matchCount').textContent = filteredMatches.length;
        
        if (filteredMatches.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="empty-state">No matches found</td></tr>';
            return;
        }
        
        tbody.innerHTML = filteredMatches.map(match => {
            const playerAName = playerMap[match.player_a_id] || 'Unknown';
            const playerBName = playerMap[match.player_b_id] || 'Unknown';
            const isPlayerAWinner = match.winner_id === match.player_a_id;
            
            const winnerName = isPlayerAWinner ? playerAName : playerBName;
            const loserName = isPlayerAWinner ? playerBName : playerAName;
            const winnerSets = isPlayerAWinner ? match.player_a_sets : match.player_b_sets;
            const loserSets = isPlayerAWinner ? match.player_b_sets : match.player_a_sets;
            
            const dateObj = new Date(match.date);
            const formattedDate = dateObj.toLocaleDateString('en-GB', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            });
            
            return `
                <tr data-winner-id="${match.winner_id}" data-loser-id="${isPlayerAWinner ? match.player_b_id : match.player_a_id}">
                    <td class="date-cell">${formattedDate}</td>
                    <td class="winner">${winnerName}</td>
                    <td class="score">${winnerSets} - ${loserSets}</td>
                    <td class="loser">${loserName}</td>
                </tr>
            `;
        }).join('');
    }
    
    // Sort functionality
    let sortDirection = {};
    
    function sortTable(columnIndex) {
        const tbody = document.getElementById('matchesTableBody');
        const rows = Array.from(tbody.querySelectorAll('tr:not(.empty-state)'));
        const headers = document.querySelectorAll('th');
        
        if (rows.length === 0) return;
        
        sortDirection[columnIndex] = !sortDirection[columnIndex];
        const ascending = sortDirection[columnIndex];
        
        headers.forEach(h => h.classList.remove('sorted'));
        headers[columnIndex].classList.add('sorted');
        
        rows.sort((a, b) => {
            let aVal = a.cells[columnIndex]?.textContent.trim() || '';
            let bVal = b.cells[columnIndex]?.textContent.trim() || '';
            
            // Handle date column
            if (columnIndex === 0) {
                aVal = new Date(aVal);
                bVal = new Date(bVal);
                return ascending ? aVal - bVal : bVal - aVal;
            }
            
            // Default string comparison
            return ascending ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
        });
        
        rows.forEach(row => tbody.appendChild(row));
    }
    
    // Load on page ready
    document.addEventListener('DOMContentLoaded', loadMatches);
</script>

</body>
</html>
